/**
 * Framework-agnostic dev widget using Web Components
 * Displays translation status in development mode
 */

import type { LingoDevState, WidgetPosition } from "./types";

/**
 * Lingo.dev Dev Widget Custom Element
 *
 * This Web Component displays translation status and updates based on
 * window.__LINGO_DEV_STATE__ changes triggered by TranslationProvider.
 */
class LingoDevWidget extends HTMLElement {
  private shadow: ShadowRoot;
  private state: LingoDevState | null = null;

  constructor() {
    super();
    this.shadow = this.attachShadow({ mode: "open" });
  }

  connectedCallback() {
    // Subscribe to state updates
    window.__LINGO_DEV_UPDATE__ = () => {
      this.state = window.__LINGO_DEV_STATE__ || null;
      this.render();
    };

    // Initial render with existing state
    if (window.__LINGO_DEV_STATE__) {
      this.state = window.__LINGO_DEV_STATE__;
      this.render();
    }
  }

  disconnectedCallback() {
    // Cleanup
    if (window.__LINGO_DEV_UPDATE__) {
      delete window.__LINGO_DEV_UPDATE__;
    }
  }

  private render() {
    // Hide widget when on source locale
    if (!this.state || this.state.locale === this.state.sourceLocale) {
      this.shadow.innerHTML = "";
      return;
    }

    const { isLoading, locale, pendingCount, position } = this.state;

    this.shadow.innerHTML = `
      <style>
        ${this.getStyles(position)}
      </style>
      <div class="container">
        ${isLoading ? this.renderLoader() : this.renderLogo()}
        <svg width="110" height="26" viewBox="100 0 866 150" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M603.358 114.159H585.444V96.4009H603.358V114.159Z" fill="white"/>
<path d="M632.752 110.535C627.19 107.075 622.794 102.196 619.552 95.9164C616.315 89.6366 614.671 82.4972 614.671 74.5379C614.671 66.5781 616.292 59.4791 619.552 53.2393C622.794 46.9998 627.213 42.1601 632.752 38.7005C638.313 35.2407 644.492 33.5208 651.312 33.5208C661.269 33.5208 669.231 37.3006 675.208 44.84H675.987V4.10303H691.546V114.155H678.19L676.61 104.095H675.831C669.75 111.855 661.569 115.735 651.312 115.735C644.492 115.735 638.313 114.015 632.752 110.555V110.535ZM664.592 97.9558C668.088 95.756 670.869 92.6164 672.929 88.5168C674.971 84.4368 675.987 79.7574 675.987 74.5177C675.987 69.2781 674.971 64.6385 672.929 60.5989C670.892 56.5591 668.112 53.4393 664.592 51.2395C661.073 49.0397 657.271 47.9398 653.192 47.9398C649.113 47.9398 645.173 49.0397 641.712 51.2395C638.25 53.4393 635.492 56.5591 633.45 60.5989C631.413 64.6385 630.392 69.2781 630.392 74.5177C630.392 79.7574 631.413 84.5568 633.45 88.597C635.492 92.6366 638.25 95.756 641.712 97.9558C645.173 100.156 648.992 101.256 653.192 101.256C657.392 101.256 661.073 100.156 664.592 97.9558Z" fill="white"/>
<path d="M728.192 96.1339C732.992 99.6935 737.89 102.193 744.069 102.193C748.471 102.193 752.348 101.193 755.711 99.2135C759.069 97.2139 761.567 94.6541 763.252 91.5144H779.446C777.029 98.5339 772.788 104.333 766.708 108.893C760.627 113.453 753.092 115.733 744.069 115.733C736.731 115.733 730.073 113.972 724.113 110.473C718.131 106.973 713.452 102.093 710.031 95.854C706.633 89.6146 704.931 82.515 704.931 74.5558C704.931 66.596 706.633 59.6567 710.031 53.4171C713.434 47.1776 718.131 42.318 724.113 38.7982C730.09 35.2985 736.731 33.5386 744.069 33.5386C751.408 33.5386 757.448 35.2185 763.171 38.5782C768.888 41.938 773.388 46.5376 776.688 52.4172C779.988 58.2969 781.65 64.8964 781.65 72.2158C781.65 75.8752 781.39 78.6554 780.865 80.5552H720.433L733.39 68.6158H766.269C765.75 62.3366 763.431 57.1368 759.352 53.0572C755.267 48.9774 750.167 46.9176 744.11 46.9176C738.052 46.9176 732.531 48.9574 728.233 53.0572C723.934 57.1368 721.373 62.3366 720.531 68.6158C720.531 68.6158 717.213 88.0546 728.233 96.1939L728.192 96.1339Z" fill="white"/>
<path d="M833.984 114.159H811.183L783.364 35.0852H799.726L821.101 96.5609H824.245L845.62 35.0852H861.982L834.001 114.159H833.984Z" fill="white"/>
<path d="M308.144 20.1422H291.166V4.42334H308.144V20.1422ZM307.364 114.155H291.806V35.0811H307.364V114.155Z" fill="white"/>
<path d="M324.494 114.157V35.0831H337.853L339.433 43.2625H340.213C342.193 40.7426 345.233 38.5028 349.332 36.5029C353.412 34.5031 358.132 33.5232 363.491 33.5232C369.571 33.5232 374.99 34.9231 379.77 37.6829C384.53 40.4627 388.27 44.3624 390.929 49.402C393.609 54.4416 394.929 60.2014 394.929 66.7005V114.177H379.37V67.9605C379.37 62.3009 377.53 57.5814 373.871 53.8017C370.211 50.0219 365.651 48.1421 360.191 48.1421C356.532 48.1421 353.152 49.042 350.052 50.8219C346.953 52.6017 344.532 55.0216 342.733 58.0616C340.953 61.1009 340.053 64.4009 340.053 67.9605V114.177H324.494V114.157Z" fill="white"/>
<path d="M426.909 142.915C421.509 140.095 417.389 136.556 414.569 132.296C411.749 128.037 410.23 123.737 410.01 119.318H425.728C426.148 122.977 428.148 126.217 431.708 128.976C435.268 131.757 440.207 133.136 446.487 133.136C452.766 133.136 458.166 131.296 462.046 127.637C465.925 123.957 467.866 119.097 467.866 113.018V100.439H467.086C464.365 103.479 460.946 105.898 456.866 107.678C452.787 109.458 448.267 110.358 443.347 110.358C436.528 110.358 430.388 108.738 424.869 105.478C419.369 102.238 415.049 97.6788 411.91 91.7994C408.77 85.9396 407.19 79.2802 407.19 71.8408C407.19 64.4014 408.77 57.7621 411.91 51.9623C415.049 46.1427 419.369 41.623 424.869 38.3633C430.368 35.1235 436.528 33.4836 443.347 33.4836C448.387 33.4836 453.006 34.4836 457.266 36.4635C461.506 38.4633 464.946 41.1231 467.566 44.4829H468.346L469.925 35.0435H483.444V113.178C483.444 119.877 481.984 125.797 479.045 130.936C476.105 136.076 471.845 140.056 466.225 142.876C460.626 145.715 454.046 147.115 446.487 147.115C438.928 147.115 432.308 145.695 426.909 142.876V142.915ZM456.766 93.1592C460.166 91.1192 462.866 88.2398 464.866 84.5198C466.865 80.8004 467.845 76.5802 467.845 71.861C467.845 67.1412 466.846 62.9614 464.866 59.2817C462.866 55.622 460.166 52.7622 456.766 50.7224C453.366 48.6825 449.567 47.6626 445.367 47.6626C438.868 47.6626 433.508 49.9224 429.248 54.4221C425.009 58.9217 422.889 64.7412 422.889 71.8806C422.889 79.02 425.009 84.9796 429.248 89.4796C433.488 93.979 438.868 96.2389 445.367 96.2389C449.567 96.2389 453.366 95.2189 456.766 93.1794V93.1592Z" fill="white"/>
<path d="M515.017 110.457C509.037 106.958 504.358 102.078 500.938 95.8386C497.538 89.5991 495.838 82.4995 495.838 74.5403C495.838 66.5805 497.538 59.6412 500.938 53.4017C504.337 47.1622 509.037 42.3025 515.017 38.7828C520.997 35.283 527.636 33.5232 534.975 33.5232C542.315 33.5232 548.934 35.283 554.854 38.7828C560.773 42.3025 565.433 47.1622 568.853 53.4017C572.253 59.6412 573.952 66.6809 573.952 74.5403C573.952 82.3997 572.253 89.5991 568.853 95.8386C565.453 102.078 560.773 106.958 554.854 110.457C548.934 113.977 542.295 115.717 534.975 115.717C527.656 115.717 520.976 113.957 515.017 110.457ZM546.834 97.9582C550.454 95.7584 553.314 92.6187 555.394 88.5191C557.493 84.4391 558.534 79.7597 558.534 74.5201C558.534 69.2805 557.493 64.6409 555.394 60.6012C553.294 56.5615 550.434 53.4417 546.834 51.2419C543.214 49.042 539.255 47.9421 534.975 47.9421C530.696 47.9421 526.716 49.042 523.116 51.2419C519.497 53.4417 516.637 56.5615 514.557 60.6012C512.457 64.6409 511.417 69.2805 511.417 74.5201C511.417 79.7597 512.457 84.4195 514.557 88.5191C516.656 92.5986 519.516 95.7584 523.116 97.9582C526.736 100.158 530.696 101.258 534.975 101.258C539.255 101.258 543.235 100.158 546.834 97.9582Z" fill="white"/>
<path d="M281.781 112.936H211.986V2.88477H228.484V97.2175L228.784 112.936L246.083 97.2175H281.781V112.936Z" fill="white"/>
</svg>
      </div>
    `;
  }

  private getStyles(position: WidgetPosition): string {
    const positions = {
      "bottom-left": "bottom: 60px; left: 16px;",
      "bottom-right": "bottom: 60px; right: 16px;",
      "top-left": "top: 16px; left: 16px;",
      "top-right": "top: 16px; right: 16px;",
    };

    return `
      :host {
        position: fixed;
        z-index: 9999;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", sans-serif;
        font-size: 12px;
        pointer-events: auto;
        ${positions[position]}
      }

      .container {
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease-in-out;
      }

      .logo {
        width: 26px;
        height: 26px;
        flex-shrink: 0;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .loading {
      }

      .idle {
        display: flex;
        align-items: center;
        padding: 6px 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
        opacity: 0.7;
        transition: opacity 0.2s ease-in-out;
        cursor: default;
      }

      .spinner {
        display: inline-block;
        font-size: 16px;
        animation: lingo-spin 1s linear infinite;
      }

      @keyframes lingo-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .content {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .title {
        font-weight: 500;
        font-size: 12px;
        line-height: 16px;
      }

      .subtitle {
        font-size: 11px;
        opacity: 0.8;
        line-height: 14px;
      }
    `;
  }

  private renderLogo(): string {
    return `
      <svg class="logo" width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0.0528644 9.3081L9.51858 19.6347C9.55631 19.6754 9.60893 19.6992 9.66454 19.6992H25.1832C25.36 19.6992 25.4483 19.4857 25.3232 19.3606L18.5126 12.5501H13.1508V15.231L6.89523 8.97546H0.198827C0.026055 8.97546 -0.0643027 9.181 0.0528644 9.3081Z" fill="#69E300"/>
        <path d="M25.3593 12.2182L15.8926 1.89157C15.8548 1.85086 15.8022 1.82703 15.7466 1.82703H0.227916C0.0501791 1.82703 -0.0381927 2.04051 0.0869179 2.16562L6.8975 8.9762H12.2594V6.29526L18.5149 12.5508H25.2123C25.3851 12.5508 25.4754 12.3453 25.3583 12.2182H25.3593Z" fill="#69E300"/>
      </svg>
    `;
  }

  private renderLoader(): string {
    return `
      <div class="loading">
        <span class="spinner"></span>
      </div>
    `;
  }
}

// Register custom element
if (typeof window !== "undefined" && !customElements.get("lingo-dev-widget")) {
  customElements.define("lingo-dev-widget", LingoDevWidget);
}

export { LingoDevWidget };
