name: PR Assignment Check

on:
  pull_request_target:
    types: [opened, reopened, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to check"
        required: true
        type: number

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            EXEMPT USERS: @maxprilutskiy, @vrcprl, @davidturnbull, @monicabe, @sumitsaurabh927, @AleksandrSl (skip all checks if PR author is one of these)

            Check if this PR references any issues (via "Closes #123", "Fixes #456", etc.).

            For each referenced issue:
            1. Check if the issue has assignees
            2. If yes, check if the PR author is one of the assignees
            3. If the PR author is NOT an assignee, close this PR with a brief, friendly comment (2-3 sentences, no emojis) explaining:
               - The issue was already assigned to someone else
               - They should wait to be assigned before submitting PRs
               - Encourage them to find other unassigned issues

            If no issues referenced or PR author is properly assigned, do nothing.
          claude_args: |
            --max-turns 3
            --allowedTools "Bash,Read,Grep,Glob"
